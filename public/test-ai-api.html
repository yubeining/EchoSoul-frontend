<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI角色API测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #007bff;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🤖 AI角色API测试工具</h1>
        <p>此页面用于测试AI角色相关的API接口功能</p>
        
        <div class="test-section">
            <h3>🔐 认证设置</h3>
            <div class="form-group">
                <label for="token">JWT Token:</label>
                <input type="text" id="token" placeholder="请输入JWT Token">
            </div>
            <button onclick="setToken()">设置Token</button>
            <button onclick="clearToken()">清除Token</button>
            <div id="tokenStatus" class="result"></div>
        </div>
    </div>

    <div class="grid">
        <div class="container">
            <h2>📝 AI角色CRUD操作</h2>
            
            <div class="test-section">
                <h3>创建AI角色</h3>
                <div class="form-group">
                    <label for="createName">角色名称:</label>
                    <input type="text" id="createName" value="测试AI角色">
                </div>
                <div class="form-group">
                    <label for="createNickname">角色昵称:</label>
                    <input type="text" id="createNickname" value="test_ai">
                </div>
                <div class="form-group">
                    <label for="createDescription">角色描述:</label>
                    <textarea id="createDescription" rows="3">这是一个测试AI角色，用于验证API功能。</textarea>
                </div>
                <div class="form-group">
                    <label for="createPersonality">性格特点:</label>
                    <input type="text" id="createPersonality" value="友好、专业、幽默">
                </div>
                <div class="form-group">
                    <label for="createSpeakingStyle">对话风格:</label>
                    <select id="createSpeakingStyle">
                        <option value="">请选择</option>
                        <option value="formal">正式</option>
                        <option value="casual">随意</option>
                        <option value="friendly" selected>友好</option>
                        <option value="professional">专业</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="createIsPublic"> 公开此角色
                    </label>
                </div>
                <button onclick="createCharacter()">创建AI角色</button>
                <div id="createResult" class="result"></div>
            </div>

            <div class="test-section">
                <h3>获取AI角色列表</h3>
                <div class="form-group">
                    <label for="listType">列表类型:</label>
                    <select id="listType">
                        <option value="public" selected>公开角色</option>
                        <option value="my">我创建的</option>
                        <option value="favorited">我收藏的</option>
                    </select>
                </div>
                <button onclick="getCharacters()">获取角色列表</button>
                <div id="listResult" class="result"></div>
            </div>

            <div class="test-section">
                <h3>获取AI角色详情</h3>
                <div class="form-group">
                    <label for="characterId">角色ID:</label>
                    <input type="text" id="characterId" placeholder="请输入角色ID">
                </div>
                <button onclick="getCharacterDetail()">获取角色详情</button>
                <div id="detailResult" class="result"></div>
            </div>
        </div>

        <div class="container">
            <h2>💬 AI对话功能</h2>
            
            <div class="test-section">
                <h3>创建AI会话</h3>
                <div class="form-group">
                    <label for="chatCharacterId">角色ID:</label>
                    <input type="text" id="chatCharacterId" placeholder="请输入角色ID">
                </div>
                <button onclick="createAIConversation()">创建AI会话</button>
                <div id="conversationResult" class="result"></div>
            </div>

            <div class="test-section">
                <h3>发送消息到AI</h3>
                <div class="form-group">
                    <label for="conversationId">会话ID:</label>
                    <input type="text" id="conversationId" placeholder="请输入会话ID">
                </div>
                <div class="form-group">
                    <label for="messageContent">消息内容:</label>
                    <textarea id="messageContent" rows="3" placeholder="请输入要发送的消息">你好，请介绍一下你自己！</textarea>
                </div>
                <button onclick="sendMessageToAI()">发送消息</button>
                <div id="messageResult" class="result"></div>
            </div>

            <div class="test-section">
                <h3>获取AI会话列表</h3>
                <button onclick="getAIConversations()">获取AI会话列表</button>
                <div id="aiConversationsResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        // API基础配置
        const API_BASE_URLS = [
            'https://glbbvnrguhix.sealosbja.site',  // 调试环境
            'https://ohciuodbxwdp.sealosbja.site'   // 线上环境
        ];

        let currentToken = '';

        // 设置Token
        function setToken() {
            currentToken = document.getElementById('token').value.trim();
            const status = document.getElementById('tokenStatus');
            if (currentToken) {
                status.textContent = '✅ Token已设置';
                status.className = 'result success';
            } else {
                status.textContent = '❌ Token为空';
                status.className = 'result error';
            }
        }

        // 清除Token
        function clearToken() {
            currentToken = '';
            document.getElementById('token').value = '';
            document.getElementById('tokenStatus').textContent = 'Token已清除';
            document.getElementById('tokenStatus').className = 'result';
        }

        // 通用API请求函数
        async function makeRequest(endpoint, method = 'GET', data = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (currentToken) {
                headers['Authorization'] = `Bearer ${currentToken}`;
            }

            const options = {
                method,
                headers,
                mode: 'cors'
            };

            if (data && method !== 'GET') {
                options.body = JSON.stringify(data);
            }

            for (const baseUrl of API_BASE_URLS) {
                try {
                    console.log(`尝试请求: ${baseUrl}${endpoint}`);
                    const response = await fetch(`${baseUrl}${endpoint}`, options);
                    const result = await response.json();
                    
                    if (response.ok) {
                        return { success: true, data: result, url: baseUrl };
                    } else {
                        console.warn(`请求失败: ${baseUrl}${endpoint}`, result);
                    }
                } catch (error) {
                    console.warn(`请求错误: ${baseUrl}${endpoint}`, error);
                }
            }
            
            throw new Error('所有服务器都无法访问');
        }

        // 创建AI角色
        async function createCharacter() {
            const resultDiv = document.getElementById('createResult');
            resultDiv.textContent = '创建中...';
            resultDiv.className = 'result';

            try {
                const data = {
                    name: document.getElementById('createName').value,
                    nickname: document.getElementById('createNickname').value,
                    description: document.getElementById('createDescription').value,
                    personality: document.getElementById('createPersonality').value,
                    speaking_style: document.getElementById('createSpeakingStyle').value,
                    is_public: document.getElementById('createIsPublic').checked
                };

                const result = await makeRequest('/api/ai/characters', 'POST', data);
                resultDiv.textContent = `✅ 创建成功!\n服务器: ${result.url}\n响应: ${JSON.stringify(result.data, null, 2)}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `❌ 创建失败: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 获取AI角色列表
        async function getCharacters() {
            const resultDiv = document.getElementById('listResult');
            resultDiv.textContent = '获取中...';
            resultDiv.className = 'result';

            try {
                const listType = document.getElementById('listType').value;
                const result = await makeRequest(`/api/ai/characters?list_type=${listType}&page=1&limit=20`);
                resultDiv.textContent = `✅ 获取成功!\n服务器: ${result.url}\n响应: ${JSON.stringify(result.data, null, 2)}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `❌ 获取失败: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 获取AI角色详情
        async function getCharacterDetail() {
            const resultDiv = document.getElementById('detailResult');
            const characterId = document.getElementById('characterId').value.trim();
            
            if (!characterId) {
                resultDiv.textContent = '❌ 请输入角色ID';
                resultDiv.className = 'result error';
                return;
            }

            resultDiv.textContent = '获取中...';
            resultDiv.className = 'result';

            try {
                const result = await makeRequest(`/api/ai/characters/${characterId}`);
                resultDiv.textContent = `✅ 获取成功!\n服务器: ${result.url}\n响应: ${JSON.stringify(result.data, null, 2)}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `❌ 获取失败: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 创建AI会话
        async function createAIConversation() {
            const resultDiv = document.getElementById('conversationResult');
            const characterId = document.getElementById('chatCharacterId').value.trim();
            
            if (!characterId) {
                resultDiv.textContent = '❌ 请输入角色ID';
                resultDiv.className = 'result error';
                return;
            }

            resultDiv.textContent = '创建中...';
            resultDiv.className = 'result';

            try {
                const data = { character_id: characterId };
                const result = await makeRequest('/api/ai/conversations/ai', 'POST', data);
                resultDiv.textContent = `✅ 创建成功!\n服务器: ${result.url}\n响应: ${JSON.stringify(result.data, null, 2)}`;
                resultDiv.className = 'result success';
                
                // 自动填充会话ID
                if (result.data.data && result.data.data.conversation_id) {
                    document.getElementById('conversationId').value = result.data.data.conversation_id;
                }
            } catch (error) {
                resultDiv.textContent = `❌ 创建失败: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 发送消息到AI
        async function sendMessageToAI() {
            const resultDiv = document.getElementById('messageResult');
            const conversationId = document.getElementById('conversationId').value.trim();
            const content = document.getElementById('messageContent').value.trim();
            
            if (!conversationId || !content) {
                resultDiv.textContent = '❌ 请输入会话ID和消息内容';
                resultDiv.className = 'result error';
                return;
            }

            resultDiv.textContent = '发送中...';
            resultDiv.className = 'result';

            try {
                const result = await makeRequest(`/api/chat/messages/ai?conversation_id=${conversationId}&content=${encodeURIComponent(content)}`, 'POST');
                resultDiv.textContent = `✅ 发送成功!\n服务器: ${result.url}\n响应: ${JSON.stringify(result.data, null, 2)}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `❌ 发送失败: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 获取AI会话列表
        async function getAIConversations() {
            const resultDiv = document.getElementById('aiConversationsResult');
            resultDiv.textContent = '获取中...';
            resultDiv.className = 'result';

            try {
                const result = await makeRequest('/api/chat/conversations/ai?page=1&limit=20');
                resultDiv.textContent = `✅ 获取成功!\n服务器: ${result.url}\n响应: ${JSON.stringify(result.data, null, 2)}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `❌ 获取失败: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 页面加载时检查Token
        window.onload = function() {
            const savedToken = localStorage.getItem('echosoul_token');
            if (savedToken) {
                document.getElementById('token').value = savedToken;
                setToken();
            }
        };
    </script>
</body>
</html>

