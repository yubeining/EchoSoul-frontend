<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´æ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .time-display {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .error {
            color: red;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            color: green;
            background-color: #d4edda;
            padding: 10px;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ• æ—¶é—´æ˜¾ç¤ºæµ‹è¯•</h1>
        <p>æµ‹è¯•å‰ç«¯æ—¶é—´æ ¼å¼åŒ–å’Œæ—¶åŒºå¤„ç†é—®é¢˜</p>
        
        <div class="test-section">
            <h3>1. å½“å‰ç³»ç»Ÿæ—¶é—´æµ‹è¯•</h3>
            <div id="currentTime" class="time-display"></div>
            <button onclick="updateCurrentTime()">åˆ·æ–°å½“å‰æ—¶é—´</button>
        </div>

        <div class="test-section">
            <h3>2. æ—¶é—´æ ¼å¼åŒ–æµ‹è¯•</h3>
            <div id="formatTest" class="time-display"></div>
            <button onclick="testTimeFormatting()">æµ‹è¯•æ—¶é—´æ ¼å¼åŒ–</button>
        </div>

        <div class="test-section">
            <h3>3. æ¨¡æ‹Ÿåç«¯æ—¶é—´æˆ³æµ‹è¯•</h3>
            <div id="backendTimeTest" class="time-display"></div>
            <button onclick="testBackendTimestamps()">æµ‹è¯•åç«¯æ—¶é—´æˆ³</button>
        </div>

        <div class="test-section">
            <h3>4. HTTP API æ—¶é—´æµ‹è¯•</h3>
            <div id="httpTimeTest" class="time-display"></div>
            <button onclick="testHttpTime()">æµ‹è¯•HTTPæ—¶é—´</button>
        </div>

        <div class="test-section">
            <h3>5. WebSocket æ—¶é—´æµ‹è¯•</h3>
            <div id="wsTimeTest" class="time-display"></div>
            <button onclick="testWebSocketTime()">æµ‹è¯•WebSocketæ—¶é—´</button>
        </div>

        <div class="test-section">
            <h3>6. æ—¶åŒºå¯¹æ¯”æµ‹è¯•</h3>
            <div id="timezoneTest" class="time-display"></div>
            <button onclick="testTimezoneComparison()">æµ‹è¯•æ—¶åŒºå¯¹æ¯”</button>
        </div>

        <h3>æµ‹è¯•æ—¥å¿—:</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateCurrentTime() {
            const now = new Date();
            const display = document.getElementById('currentTime');
            display.innerHTML = `
                <strong>å½“å‰ç³»ç»Ÿæ—¶é—´:</strong><br>
                åŸå§‹æ—¶é—´: ${now.toString()}<br>
                ISOå­—ç¬¦ä¸²: ${now.toISOString()}<br>
                æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²: ${now.toLocaleString('zh-CN')}<br>
                æœ¬åœ°æ—¶é—´(24å°æ—¶): ${now.toLocaleTimeString('zh-CN', { hour12: false })}<br>
                æ—¶åŒºåç§»: ${now.getTimezoneOffset()} åˆ†é’Ÿ<br>
                UTCæ—¶é—´: ${now.toUTCString()}
            `;
            log('æ›´æ–°å½“å‰ç³»ç»Ÿæ—¶é—´æ˜¾ç¤º');
        }

        function testTimeFormatting() {
            const now = new Date();
            const testTimes = [
                now.toISOString(),
                now.toString(),
                now.toLocaleString('zh-CN'),
                '2025-09-20T18:55:00.000Z', // æ¨¡æ‹Ÿåç«¯UTCæ—¶é—´
                '2025-09-20T18:55:00.000+08:00', // æ¨¡æ‹Ÿåç«¯åŒ—äº¬æ—¶é—´
                '2025-09-20T10:55:00.000Z' // æ¨¡æ‹Ÿåç«¯UTCæ—¶é—´(å¯¹åº”åŒ—äº¬æ—¶é—´18:55)
            ];

            const display = document.getElementById('formatTest');
            let html = '<strong>æ—¶é—´æ ¼å¼åŒ–æµ‹è¯•:</strong><br>';
            
            testTimes.forEach((timeStr, index) => {
                try {
                    const date = new Date(timeStr);
                    const formatted = date.toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    });
                    html += `${index + 1}. ${timeStr} â†’ ${formatted}<br>`;
                    log(`æ ¼å¼åŒ–æµ‹è¯• ${index + 1}: ${timeStr} â†’ ${formatted}`);
                } catch (e) {
                    html += `${index + 1}. ${timeStr} â†’ é”™è¯¯: ${e.message}<br>`;
                    log(`æ ¼å¼åŒ–é”™è¯¯ ${index + 1}: ${timeStr} â†’ ${e.message}`);
                }
            });
            
            display.innerHTML = html;
        }

        function testBackendTimestamps() {
            const display = document.getElementById('backendTimeTest');
            let html = '<strong>æ¨¡æ‹Ÿåç«¯æ—¶é—´æˆ³æµ‹è¯•:</strong><br>';
            
            // æ¨¡æ‹Ÿä¸åŒçš„åç«¯æ—¶é—´æ ¼å¼
            const backendTimes = [
                { name: 'UTCæ—¶é—´(ISO)', time: '2025-09-20T10:55:00.000Z', expected: '18:55' },
                { name: 'UTCæ—¶é—´(æ— Z)', time: '2025-09-20T10:55:00.000', expected: '18:55' },
                { name: 'åŒ—äº¬æ—¶é—´(ISO)', time: '2025-09-20T18:55:00.000+08:00', expected: '18:55' },
                { name: 'Unixæ—¶é—´æˆ³', time: 1726841700000, expected: '18:55' },
                { name: 'å½“å‰æ—¶é—´', time: new Date().toISOString(), expected: 'å½“å‰æ—¶é—´' }
            ];
            
            backendTimes.forEach(test => {
                try {
                    const date = new Date(test.time);
                    const formatted = date.toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    });
                    const isCorrect = test.expected === 'å½“å‰æ—¶é—´' || formatted === test.expected;
                    html += `${test.name}: ${test.time} â†’ ${formatted} ${isCorrect ? 'âœ…' : 'âŒ'}<br>`;
                    log(`åç«¯æ—¶é—´æµ‹è¯• ${test.name}: ${test.time} â†’ ${formatted}`);
                } catch (e) {
                    html += `${test.name}: ${test.time} â†’ é”™è¯¯: ${e.message}<br>`;
                    log(`åç«¯æ—¶é—´é”™è¯¯ ${test.name}: ${test.time} â†’ ${e.message}`);
                }
            });
            
            display.innerHTML = html;
        }

        async function testHttpTime() {
            const display = document.getElementById('httpTimeTest');
            display.innerHTML = '<strong>HTTP API æ—¶é—´æµ‹è¯•:</strong><br>æ­£åœ¨æµ‹è¯•...';
            
            try {
                // æµ‹è¯•å‘é€æ¶ˆæ¯API
                const response = await fetch('/api/chat/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: 'test-conversation-123',
                        content: 'HTTPæ—¶é—´æµ‹è¯•æ¶ˆæ¯',
                        message_type: 'text'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const messageTime = data.data?.create_time || data.timestamp;
                    const date = new Date(messageTime);
                    const formatted = date.toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    });
                    
                    display.innerHTML = `
                        <strong>HTTP API æ—¶é—´æµ‹è¯•:</strong><br>
                        åŸå§‹æ—¶é—´æˆ³: ${messageTime}<br>
                        æ ¼å¼åŒ–æ—¶é—´: ${formatted}<br>
                        å½“å‰æ—¶é—´: ${new Date().toLocaleTimeString('zh-CN', { hour12: false })}<br>
                        æ—¶é—´å·®: ${Math.abs(new Date().getTime() - date.getTime()) / 1000} ç§’
                    `;
                    log(`HTTPæ—¶é—´æµ‹è¯•æˆåŠŸ: ${messageTime} â†’ ${formatted}`);
                } else {
                    display.innerHTML = `<strong>HTTP API æ—¶é—´æµ‹è¯•:</strong><br>APIè°ƒç”¨å¤±è´¥: ${response.status}`;
                    log(`HTTPæ—¶é—´æµ‹è¯•å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                display.innerHTML = `<strong>HTTP API æ—¶é—´æµ‹è¯•:</strong><br>é”™è¯¯: ${error.message}`;
                log(`HTTPæ—¶é—´æµ‹è¯•é”™è¯¯: ${error.message}`);
            }
        }

        function testWebSocketTime() {
            const display = document.getElementById('wsTimeTest');
            display.innerHTML = '<strong>WebSocket æ—¶é—´æµ‹è¯•:</strong><br>æ­£åœ¨è¿æ¥...';
            
            const userId = 10000000;
            const wsUrl = `ws://localhost:8000/api/ws/${userId}`;
            
            try {
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    log('WebSocketè¿æ¥æˆåŠŸ');
                    display.innerHTML = '<strong>WebSocket æ—¶é—´æµ‹è¯•:</strong><br>è¿æ¥æˆåŠŸï¼Œå‘é€æµ‹è¯•æ¶ˆæ¯...';
                    
                    // å‘é€æµ‹è¯•æ¶ˆæ¯
                    const testMessage = {
                        type: 'chat_message',
                        conversation_id: 'test-conversation-123',
                        content: 'WebSocketæ—¶é—´æµ‹è¯•æ¶ˆæ¯',
                        message_type: 'text'
                    };
                    
                    ws.send(JSON.stringify(testMessage));
                    log('å‘é€WebSocketæµ‹è¯•æ¶ˆæ¯');
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log('æ”¶åˆ°WebSocketæ¶ˆæ¯: ' + JSON.stringify(data));
                        
                        if (data.type === 'new_message' && data.data) {
                            const messageTime = data.data.timestamp;
                            const date = new Date(messageTime);
                            const formatted = date.toLocaleTimeString('zh-CN', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                hour12: false
                            });
                            
                            display.innerHTML = `
                                <strong>WebSocket æ—¶é—´æµ‹è¯•:</strong><br>
                                åŸå§‹æ—¶é—´æˆ³: ${messageTime}<br>
                                æ ¼å¼åŒ–æ—¶é—´: ${formatted}<br>
                                å½“å‰æ—¶é—´: ${new Date().toLocaleTimeString('zh-CN', { hour12: false })}<br>
                                æ—¶é—´å·®: ${Math.abs(new Date().getTime() - date.getTime()) / 1000} ç§’
                            `;
                            log(`WebSocketæ—¶é—´æµ‹è¯•æˆåŠŸ: ${messageTime} â†’ ${formatted}`);
                        }
                    } catch (e) {
                        log('WebSocketæ¶ˆæ¯è§£æé”™è¯¯: ' + e.message);
                    }
                };
                
                ws.onerror = function(error) {
                    display.innerHTML = `<strong>WebSocket æ—¶é—´æµ‹è¯•:</strong><br>è¿æ¥é”™è¯¯: ${error}`;
                    log('WebSocketè¿æ¥é”™è¯¯: ' + error);
                };
                
                ws.onclose = function() {
                    log('WebSocketè¿æ¥å…³é—­');
                };
                
            } catch (error) {
                display.innerHTML = `<strong>WebSocket æ—¶é—´æµ‹è¯•:</strong><br>é”™è¯¯: ${error.message}`;
                log(`WebSocketæ—¶é—´æµ‹è¯•é”™è¯¯: ${error.message}`);
            }
        }

        function testTimezoneComparison() {
            const display = document.getElementById('timezoneTest');
            const now = new Date();
            
            // æµ‹è¯•ä¸åŒæ—¶åŒºçš„æ—¶é—´æ˜¾ç¤º
            const timezones = [
                { name: 'æœ¬åœ°æ—¶é—´(åŒ—äº¬)', time: now.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) },
                { name: 'UTCæ—¶é—´', time: now.toLocaleString('zh-CN', { timeZone: 'UTC' }) },
                { name: 'ç³»ç»Ÿé»˜è®¤', time: now.toLocaleString('zh-CN') }
            ];
            
            let html = '<strong>æ—¶åŒºå¯¹æ¯”æµ‹è¯•:</strong><br>';
            timezones.forEach(tz => {
                html += `${tz.name}: ${tz.time}<br>`;
                log(`æ—¶åŒºæµ‹è¯• ${tz.name}: ${tz.time}`);
            });
            
            html += `<br><strong>å…³é”®ä¿¡æ¯:</strong><br>`;
            html += `ç³»ç»Ÿæ—¶åŒºåç§»: ${now.getTimezoneOffset()} åˆ†é’Ÿ<br>`;
            html += `æµè§ˆå™¨æ—¶åŒº: ${Intl.DateTimeFormat().resolvedOptions().timeZone}<br>`;
            html += `å½“å‰UTCæ—¶é—´: ${now.toUTCString()}<br>`;
            html += `å½“å‰æœ¬åœ°æ—¶é—´: ${now.toString()}`;
            
            display.innerHTML = html;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ›´æ–°å½“å‰æ—¶é—´
        window.onload = function() {
            updateCurrentTime();
            log('æ—¶é—´æ˜¾ç¤ºæµ‹è¯•é¡µé¢å·²åŠ è½½');
        };
    </script>
</body>
</html>
