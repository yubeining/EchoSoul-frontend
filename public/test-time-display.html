<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间显示测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .time-display {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .error {
            color: red;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            color: green;
            background-color: #d4edda;
            padding: 10px;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🕐 时间显示测试</h1>
        <p>测试前端时间格式化和时区处理问题</p>
        
        <div class="test-section">
            <h3>1. 当前系统时间测试</h3>
            <div id="currentTime" class="time-display"></div>
            <button onclick="updateCurrentTime()">刷新当前时间</button>
        </div>

        <div class="test-section">
            <h3>2. 时间格式化测试</h3>
            <div id="formatTest" class="time-display"></div>
            <button onclick="testTimeFormatting()">测试时间格式化</button>
        </div>

        <div class="test-section">
            <h3>3. 模拟后端时间戳测试</h3>
            <div id="backendTimeTest" class="time-display"></div>
            <button onclick="testBackendTimestamps()">测试后端时间戳</button>
        </div>

        <div class="test-section">
            <h3>4. HTTP API 时间测试</h3>
            <div id="httpTimeTest" class="time-display"></div>
            <button onclick="testHttpTime()">测试HTTP时间</button>
        </div>

        <div class="test-section">
            <h3>5. WebSocket 时间测试</h3>
            <div id="wsTimeTest" class="time-display"></div>
            <button onclick="testWebSocketTime()">测试WebSocket时间</button>
        </div>

        <div class="test-section">
            <h3>6. 时区对比测试</h3>
            <div id="timezoneTest" class="time-display"></div>
            <button onclick="testTimezoneComparison()">测试时区对比</button>
        </div>

        <h3>测试日志:</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateCurrentTime() {
            const now = new Date();
            const display = document.getElementById('currentTime');
            display.innerHTML = `
                <strong>当前系统时间:</strong><br>
                原始时间: ${now.toString()}<br>
                ISO字符串: ${now.toISOString()}<br>
                本地时间字符串: ${now.toLocaleString('zh-CN')}<br>
                本地时间(24小时): ${now.toLocaleTimeString('zh-CN', { hour12: false })}<br>
                时区偏移: ${now.getTimezoneOffset()} 分钟<br>
                UTC时间: ${now.toUTCString()}
            `;
            log('更新当前系统时间显示');
        }

        function testTimeFormatting() {
            const now = new Date();
            const testTimes = [
                now.toISOString(),
                now.toString(),
                now.toLocaleString('zh-CN'),
                '2025-09-20T18:55:00.000Z', // 模拟后端UTC时间
                '2025-09-20T18:55:00.000+08:00', // 模拟后端北京时间
                '2025-09-20T10:55:00.000Z' // 模拟后端UTC时间(对应北京时间18:55)
            ];

            const display = document.getElementById('formatTest');
            let html = '<strong>时间格式化测试:</strong><br>';
            
            testTimes.forEach((timeStr, index) => {
                try {
                    const date = new Date(timeStr);
                    const formatted = date.toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    });
                    html += `${index + 1}. ${timeStr} → ${formatted}<br>`;
                    log(`格式化测试 ${index + 1}: ${timeStr} → ${formatted}`);
                } catch (e) {
                    html += `${index + 1}. ${timeStr} → 错误: ${e.message}<br>`;
                    log(`格式化错误 ${index + 1}: ${timeStr} → ${e.message}`);
                }
            });
            
            display.innerHTML = html;
        }

        function testBackendTimestamps() {
            const display = document.getElementById('backendTimeTest');
            let html = '<strong>模拟后端时间戳测试:</strong><br>';
            
            // 模拟不同的后端时间格式
            const backendTimes = [
                { name: 'UTC时间(ISO)', time: '2025-09-20T10:55:00.000Z', expected: '18:55' },
                { name: 'UTC时间(无Z)', time: '2025-09-20T10:55:00.000', expected: '18:55' },
                { name: '北京时间(ISO)', time: '2025-09-20T18:55:00.000+08:00', expected: '18:55' },
                { name: 'Unix时间戳', time: 1726841700000, expected: '18:55' },
                { name: '当前时间', time: new Date().toISOString(), expected: '当前时间' }
            ];
            
            backendTimes.forEach(test => {
                try {
                    const date = new Date(test.time);
                    const formatted = date.toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    });
                    const isCorrect = test.expected === '当前时间' || formatted === test.expected;
                    html += `${test.name}: ${test.time} → ${formatted} ${isCorrect ? '✅' : '❌'}<br>`;
                    log(`后端时间测试 ${test.name}: ${test.time} → ${formatted}`);
                } catch (e) {
                    html += `${test.name}: ${test.time} → 错误: ${e.message}<br>`;
                    log(`后端时间错误 ${test.name}: ${test.time} → ${e.message}`);
                }
            });
            
            display.innerHTML = html;
        }

        async function testHttpTime() {
            const display = document.getElementById('httpTimeTest');
            display.innerHTML = '<strong>HTTP API 时间测试:</strong><br>正在测试...';
            
            try {
                // 测试发送消息API
                const response = await fetch('/api/chat/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: 'test-conversation-123',
                        content: 'HTTP时间测试消息',
                        message_type: 'text'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const messageTime = data.data?.create_time || data.timestamp;
                    const date = new Date(messageTime);
                    const formatted = date.toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    });
                    
                    display.innerHTML = `
                        <strong>HTTP API 时间测试:</strong><br>
                        原始时间戳: ${messageTime}<br>
                        格式化时间: ${formatted}<br>
                        当前时间: ${new Date().toLocaleTimeString('zh-CN', { hour12: false })}<br>
                        时间差: ${Math.abs(new Date().getTime() - date.getTime()) / 1000} 秒
                    `;
                    log(`HTTP时间测试成功: ${messageTime} → ${formatted}`);
                } else {
                    display.innerHTML = `<strong>HTTP API 时间测试:</strong><br>API调用失败: ${response.status}`;
                    log(`HTTP时间测试失败: ${response.status}`);
                }
            } catch (error) {
                display.innerHTML = `<strong>HTTP API 时间测试:</strong><br>错误: ${error.message}`;
                log(`HTTP时间测试错误: ${error.message}`);
            }
        }

        function testWebSocketTime() {
            const display = document.getElementById('wsTimeTest');
            display.innerHTML = '<strong>WebSocket 时间测试:</strong><br>正在连接...';
            
            const userId = 10000000;
            const wsUrl = `ws://localhost:8000/api/ws/${userId}`;
            
            try {
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    log('WebSocket连接成功');
                    display.innerHTML = '<strong>WebSocket 时间测试:</strong><br>连接成功，发送测试消息...';
                    
                    // 发送测试消息
                    const testMessage = {
                        type: 'chat_message',
                        conversation_id: 'test-conversation-123',
                        content: 'WebSocket时间测试消息',
                        message_type: 'text'
                    };
                    
                    ws.send(JSON.stringify(testMessage));
                    log('发送WebSocket测试消息');
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log('收到WebSocket消息: ' + JSON.stringify(data));
                        
                        if (data.type === 'new_message' && data.data) {
                            const messageTime = data.data.timestamp;
                            const date = new Date(messageTime);
                            const formatted = date.toLocaleTimeString('zh-CN', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                hour12: false
                            });
                            
                            display.innerHTML = `
                                <strong>WebSocket 时间测试:</strong><br>
                                原始时间戳: ${messageTime}<br>
                                格式化时间: ${formatted}<br>
                                当前时间: ${new Date().toLocaleTimeString('zh-CN', { hour12: false })}<br>
                                时间差: ${Math.abs(new Date().getTime() - date.getTime()) / 1000} 秒
                            `;
                            log(`WebSocket时间测试成功: ${messageTime} → ${formatted}`);
                        }
                    } catch (e) {
                        log('WebSocket消息解析错误: ' + e.message);
                    }
                };
                
                ws.onerror = function(error) {
                    display.innerHTML = `<strong>WebSocket 时间测试:</strong><br>连接错误: ${error}`;
                    log('WebSocket连接错误: ' + error);
                };
                
                ws.onclose = function() {
                    log('WebSocket连接关闭');
                };
                
            } catch (error) {
                display.innerHTML = `<strong>WebSocket 时间测试:</strong><br>错误: ${error.message}`;
                log(`WebSocket时间测试错误: ${error.message}`);
            }
        }

        function testTimezoneComparison() {
            const display = document.getElementById('timezoneTest');
            const now = new Date();
            
            // 测试不同时区的时间显示
            const timezones = [
                { name: '本地时间(北京)', time: now.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) },
                { name: 'UTC时间', time: now.toLocaleString('zh-CN', { timeZone: 'UTC' }) },
                { name: '系统默认', time: now.toLocaleString('zh-CN') }
            ];
            
            let html = '<strong>时区对比测试:</strong><br>';
            timezones.forEach(tz => {
                html += `${tz.name}: ${tz.time}<br>`;
                log(`时区测试 ${tz.name}: ${tz.time}`);
            });
            
            html += `<br><strong>关键信息:</strong><br>`;
            html += `系统时区偏移: ${now.getTimezoneOffset()} 分钟<br>`;
            html += `浏览器时区: ${Intl.DateTimeFormat().resolvedOptions().timeZone}<br>`;
            html += `当前UTC时间: ${now.toUTCString()}<br>`;
            html += `当前本地时间: ${now.toString()}`;
            
            display.innerHTML = html;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 页面加载时自动更新当前时间
        window.onload = function() {
            updateCurrentTime();
            log('时间显示测试页面已加载');
        };
    </script>
</body>
</html>
